<div id="related_posts_block">
    <h1>Related Posts</h1>
    <div class="related_posts">
        {% capture nowday  %}{{ 'now' | date: '%Y-%m-%d' }}{% endcapture %}
        {% capture nowyear %}{{ 'now' | date: '%Y' }}{% endcapture %}
        <!-- The following code snippet was taken from http://zhangwenli.com -->
        <!-- http://zhangwenli.com/blog/2014/07/15/jekyll-related-posts-without-plugin/ -->
        {% assign hasSimilar = '' %}
        {% for post in site.categories['news_article'] limit:10 %}
            {% assign postHasSimilar = false %}
            {% for tag in post.tags %}
                {% for thisTag in page.tags %}
                    {% if postHasSimilar == false and hasSimilar.size < 3 and post.title != page.title and tag == thisTag %}
                        <div class="related_post">
                            <div class="related_post_heading">
                                <h2><a href="{{ post.url }}">{{ post.title }}</a></h2>
                            </div>
                            {% if post.date == nil %}
                                <p class="date">Undated</p>
                            {% else %}
                                <p class="date">
                                    {% capture postdate %}{{ post.date | date: '%Y-%m-%d' }}{% endcapture %}
                                    {% capture postyear %}{{ post.date | date: '%Y' }}{% endcapture %}
                                    {% if postdate == nowday %}
                                        {{ post.date | date: site.data.format.same_day }}
                                    {% elsif postyear == nowyear %}
                                        {{ post.date | date: site.data.format.same_year }}
                                    {% endif %}
                                </p>
                            {% endif %}
                            <p class="excerpt">{{ post.excerpt }}</p>
                        </div>
                        {% capture hasSimilar %}{{ hasSimilar }}*{% endcapture %}
                        {% assign postHasSimilar = true %}
                    {% endif %}
                {% endfor %}
            {% endfor %}
        {% endfor %}
        {% if hasSimilar.size == 0 %}
            <div class="related_post">
                <div class="related_post_heading">
                    <h2>No related posts</h2>
                </div>
            </div>
        {% endif %}
    </div>
</div>
    